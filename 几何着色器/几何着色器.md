# 几何着色器

##  编写几何着色器

```glsl
[maxvertexcount(N)]	
void GS(
   PrimitiveType InputVertexType inputName[NumElements],	// 输入
   inout StreamOuputObject<OutputVertexType> outputName		// 输出
) 
{
    // 几何着色器的具体实现
}
```

### 指定几何着色器的最大顶点输出

```cc
[maxvertexcount(N)] 
```

其中的 N 是单次调用几何着色器输出的顶点数量的最大值. 虽然每次调用输出的顶点个数都不一样, 但是不能超过定义的大值

出于对性能方面的考量，我们应当令maxvertexcount的值尽可能地小.

> 每次输出的标量数量在1～20时，它将发挥出最佳的性能；
>
> 而当GS每次输出的标量数量保持在27～40时，它的性能将下降到峰值性能的50%;
>
> 标量的计算方式为, **N * 顶点输出的字段数**



### 几何着色器的输入

GS 中的第一个参数, 定义了输入 

```glsl
PrimitiveType VertexOut inputName;		 
```

**`PrimitiveType`**   为图元类型.

| 类型         | 含义           |
| ------------ | -------------- |
| `point`      | 输入的是点类型 |
| `line`       | 输入的是线段   |
| `triangle`   | 输入的是三角形 |
| `lineadj`    | 输入的为线列表 |
| `trangleadj` | 输入的三角形带 |

**注意:**

> 几何着色器输入的数据必须是完整的图元（例如组成线条的两个顶点、构成三角形的3个顶点等）。因此，几何着色器并不会区分输入的图元究竟是列表结构（list）还是带状结构（strip）。举个例子，若绘制的图元实际上是三角形带，但几何着色器仍会把三角形带视作多个三角形并分别进行单独的处理，即将每个三角形的3个顶点作为其输入数据。绘制带状结构的过程中会产生额外的开销，因为多个图元所共用的顶点在几何着色器中会被处理多次

### 几何着色器的输出

GS 中的第二个参数, 定义了输出 

```glsl
inout StreamOuputObject<OutputVertexType> outputName;	// 输出
```

必须使用 `inout` 关键字声明,  另外**它必须是一种流类型(`StreamOuputObject`)**, 流类型存有一系列顶点，它们定义了几何着色器输出的几何图形. 几何着色器可以通过内置方法Append向输出流列表添加单个顶点

```glsl
void StreamOuputObject<OuputVertexType>::Append(OuputVertexType v);
```

流类型本质上是一种模板类型（template type），其模板参数用以指定输出顶点的具体类型（如GeoOut）。流类型有如下3种

| 类型                              | 函数                       |
| --------------------------------- | -------------------------- |
| `PointStream<OuputVertexType>`    | 一系列顶点所定义的点列表   |
| `LineStream<OutputVertexType>`    | 一系列顶点所定义的线条带   |
| `TriangleStream<OuputVertexType>` | 一系列顶点所定义的三角形带 |

**对于线条与三角形来说，几何着色器输出的对应图元必定是线条带与三角形带**, 而线条列表与三角形列表可借助内置函数RestartStrip来实现

```glsl
void StreamOutputObject<OuputVertexType>::RestartStrip();
```

> 例如我们不需要线条带, 而是需要线条时, 每追加两个顶点时, 必须调用一次 `RestartStrip()` 函数
>
> 例如我们需要三角形带, 而是需要三角形列表, 每追加三个顶点时, 必须调用一次 `RestartStrip()` 函数

## 几何着色器三角形细分

![subdivision](subdivision.png)

通过将同一个划分为三个小三角形, 完成三角形细分

```cc
```

