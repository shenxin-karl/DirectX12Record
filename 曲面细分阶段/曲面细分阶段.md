# 曲面细分阶段

以下是使用曲面细分的3个理由

1. 基于GPU实现动态LOD
2. 物理模拟与动画特效. 我们可以在低模网格上执行物理模拟与动画特效的相关计算, 再以镶嵌化处理手段来获取细节更加丰富的网格
3. 节约内存。我们可以在各种存储器（磁盘、RAM与VRAM）中保存低模网格，再根据需求用GPU动态地对网格进行镶嵌细分

**曲面细分位于顶点着色器与几何着色器之间**

***

## 曲面细分的图元类型

在进行曲面细分时，我们并不向IA输入装配阶段提交三角形, 而是提交具有若干控制点的面片. 

Direct3D支持具有1～32个控制点的面片，并以下列图元类型进行描述

```cc
D3D_PRIMITIVE_TOPOLOGY_1_CONTROL_POINT_PATCHLIST = 33,
D3D_PRIMITIVE_TOPOLOGY_2_CONTROL_POINT_PATCHLIST = 34,
D3D_PRIMITIVE_TOPOLOGY_3_CONTROL_POINT_PATCHLIST = 35,
D3D_PRIMITIVE_TOPOLOGY_4_CONTROL_POINT_PATCHLIST = 36,
.
.
.
D3D_PRIMITIVE_TOPOLOGY_31_CONTROL_POINT_PATCHLIST = 63,
D3D_PRIMITIVE_TOPOLOGY_32_CONTROL_POINT_PATCHLIST = 64,
```

可以将三角形看作是拥有3个控制点面片 `D3D_PRIMITIVE_3_CONTROL_POINT_PATCH`, 

可以提交需要镶嵌化处理的普通三角形网格, 对于简单的四边形面片而言, 则只需提交具有 4 个控制点的面片 `D3D_PRIMITIVE_4_CONTROL_POINT_PATCH` 即可. 这些面片最终会曲面细分阶段为多个三角形

***

## 曲面细分与顶点着色器

**在开启曲面细分之时，顶点着色器就彻底沦陷为“处理控制点的着色器”**

### 外壳着色器

在以下小节中，我们会探索外壳着色器, 它实际上是由两种着色器组成的

1. 常量外壳着色器。
2. 控制点外壳着色器

#### 常量外壳着色器

常量外壳着色器, 每个面片处理一次, 它的任务是输出网格的**曲面细分因子**

曲面细分因子指示了在曲面细分阶段中将面片镶嵌处理后的份数

下面是一个具有4个控制点的四边形面片示例，我们将它从各个方面均匀地镶嵌细分为3份

```cc
struct PatchTess {
    float EdgeTess[4]   : SV_TessFactor;
    float insideTess[4] : 
};

PatchTess ConstantHS(InputPatch<VertexOut, 4> patch, 
                     uint patchID : SV_PrimitiveID) 
{
    PatchTess pt;
    pt.EdgeTess[0] = 3;	// 四边形面片的左侧
    pt.EdgeTess[1] = 3;	// 四边形面片的上侧
    pt.EdgeTess[2] = 3;	// 四边形面片的右侧
    pt.EdgeTess[3] = 3; // 四边形面片的下侧
	
    pt.InsideTess[0] = 3;	// u 轴(四边形内部细分的列数)
    pt.InsideTess[1] = 3;	// v 轴(四边形内部细分的行数)
    return pt;
}
```

常量外壳着色器以面片的所有控制点作为输入，用 `InputPatch<VertexOut, 4>` 对此进行定义



