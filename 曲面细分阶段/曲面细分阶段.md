# 曲面细分阶段

以下是使用曲面细分的3个理由

1. 基于GPU实现动态LOD
2. 物理模拟与动画特效. 我们可以在低模网格上执行物理模拟与动画特效的相关计算, 再以镶嵌化处理手段来获取细节更加丰富的网格
3. 节约内存。我们可以在各种存储器（磁盘、RAM与VRAM）中保存低模网格，再根据需求用GPU动态地对网格进行镶嵌细分

**曲面细分位于顶点着色器与几何着色器之间**

![曲面细分流水线](曲面细分流水线.png)

***

## 曲面细分的图元类型

在进行曲面细分时，我们并不向IA输入装配阶段提交三角形, 而是提交具有若干控制点的面片. 

Direct3D支持具有1～32个控制点的面片，并以下列图元类型进行描述

```cc
D3D_PRIMITIVE_TOPOLOGY_1_CONTROL_POINT_PATCHLIST = 33,
D3D_PRIMITIVE_TOPOLOGY_2_CONTROL_POINT_PATCHLIST = 34,
D3D_PRIMITIVE_TOPOLOGY_3_CONTROL_POINT_PATCHLIST = 35,
D3D_PRIMITIVE_TOPOLOGY_4_CONTROL_POINT_PATCHLIST = 36,
.
.
.
D3D_PRIMITIVE_TOPOLOGY_31_CONTROL_POINT_PATCHLIST = 63,
D3D_PRIMITIVE_TOPOLOGY_32_CONTROL_POINT_PATCHLIST = 64,
```

可以将三角形看作是拥有3个控制点面片 `D3D_PRIMITIVE_3_CONTROL_POINT_PATCH`, 

可以提交需要镶嵌化处理的普通三角形网格, 对于简单的四边形面片而言, 则只需提交具有 4 个控制点的面片 `D3D_PRIMITIVE_4_CONTROL_POINT_PATCH` 即可. 这些面片最终会曲面细分阶段为多个三角形

***

## 曲面细分与顶点着色器

**在开启曲面细分之时，顶点着色器就彻底沦陷为“处理控制点的着色器”**

### 外壳着色器

在以下小节中，我们会探索外壳着色器, 它实际上是由两种着色器组成的

1. 常量外壳着色器。
2. 控制点外壳着色器

#### 常量外壳着色器

常量外壳着色器, 每个面片处理一次, 它的任务是输出网格的**曲面细分因子**

曲面细分因子指示了在曲面细分阶段中将面片镶嵌处理后的份数

下面是一个具有4个控制点的四边形面片示例，我们将它从各个方面均匀地镶嵌细分为3份

```cc
struct PatchTess {
    float EdgeTess[4]   : SV_TessFactor;
    float insideTess[2] : 
};

PatchTess ConstantHS(InputPatch<VertexOut, 4> patch, 
                     uint patchID : SV_PrimitiveID) 
{
    PatchTess pt;
    pt.EdgeTess[0] = 3;	// 四边形面片的左侧
    pt.EdgeTess[1] = 3;	// 四边形面片的上侧
    pt.EdgeTess[2] = 3;	// 四边形面片的右侧
    pt.EdgeTess[3] = 3; // 四边形面片的下侧
	
    pt.InsideTess[0] = 3;	// u 轴(四边形内部细分的列数)
    pt.InsideTess[1] = 3;	// v 轴(四边形内部细分的行数)
    return pt;
}
```

常量外壳着色器以面片的所有控制点作为输入，用 `InputPatch<VertexOut, 4>` 对此进行定义. 在此例中，我们的面片拥有4个控制点，所以就将 `InputPatch` 模板的第二个参数指定为 4.

系统还通过 `SV_PrimitiveID` 语义提供了面片的ID值，此ID唯一地标识了绘制调用过程中的各个面

**对四边形面片进行镶嵌化处理的过程由两个部分构成**

1. 4个边缘曲面细分因子控制着对应边缘镶嵌后的份数
2. 两个内部曲面细分因子指示了如何来对该四边形面片的内部进行镶嵌化处理

**对三角形面片（triangle patch）执行镶嵌化处理的过程同样分为两部分：**

	1. 3个边缘曲面细分因子控制着对应边上镶嵌后的份数
 	2. 一个内部曲面细分因子指示着三角形面片内部的镶嵌份数

***

**`Direct3D11` 硬件所支持的最大曲面细分因子为 `64`. 如果曲面细分因子为 0, 则面片会被丢弃, 这意味着可以做剔除优化**

1. 面片没有在视锥体内，从后续的处理中丢弃
2. 面片是背面朝向的，从后面的处理中丢弃

***

**以下是一些确定镶嵌次数的常用衡量标准:**

1. **根据与摄像机之间的距离**：物体与摄像机的距离越远，能分辨的细节就越少
2. **根据占用屏幕的范围：**可以先估算出物体覆盖屏幕的像素个数。如果数量比较少，则渲染物体的低模版本
3. **根据三角形的朝向**：三角形相对于观察者的朝向. 位于物体轮廓边缘上的三角形比其他位置的三角形更多面数
4. **根据粗糙程度：**粗糙不平的表面需要更细致的曲面细分处理. 

***

**给出了以下几点关于性能的建议:**

1. 如果曲面细分因子为1, 那么就考虑在渲染此面片时不对它进行细分处理；否则，便会在曲面细分阶段白白浪费GPU资源，因为在此阶段并不对其执行任何操作
2. 考虑到性能又涉及GPU对曲面细分的具体实现，所以不要对小于8个像素这种过小的三角形进行镶嵌化处理
3. 使用曲面细分技术时要采用批绘制调用, 绘制调用之间往复开启、关闭曲面细分功能的代价极其高昂

